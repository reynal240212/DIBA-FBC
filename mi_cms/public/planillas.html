<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>DIBA FBC - Administración</title>
  link rel="icon" href="ESCUDO.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <!-- SheetJS para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --azul-turquesa: #004D73;
      --grana: #800020;
      --dorado: #FFD700;
      --texto-claro: #ffffff;
      --texto-oscuro: #333333;
      --fondo-gris: #f4f4f4;
      --bg-patron: #2C2C2C;
    }
    body {
      font-family: "Lato", sans-serif;
      background: var(--bg-patron) url("pattern.png") repeat;
      color: var(--texto-oscuro);
      padding-top: 70px; /* Compensa el navbar fixed-top */
      transition: background 0.3s, color 0.3s;
    }
    /* NAVBAR */
    .navbar {
      background-color: var(--azul-turquesa) !important;
    }
    .navbar-brand img {
      width: 50px;
    }
    .navbar-nav .nav-link:hover {
      color: var(--dorado) !important;
    }
    /* HERO */
    .hero {
      position: relative;
      background: url("fondo.jpg") center/cover no-repeat;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
      color: var(--texto-claro);
    }
    .hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
    }
    .hero-content {
      position: relative;
      text-align: center;
    }
    .hero-title {
      font-family: "Dancing Script", cursive;
      font-size: 3.5rem;
      letter-spacing: 2px;
      margin-bottom: 1rem;
      color: var(--dorado);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .hero-subtitle {
      font-size: 1.5rem;
      color: var(--texto-claro);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
    /* TABLA */
    .table-responsive { margin-top: 1rem; }
    .table-striped > tbody > tr:nth-of-type(odd) {
      background-color: var(--fondo-gris);
    }
    .table-hover tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    thead.table-dark {
      background-color: var(--azul-turquesa) !important;
    }
    thead.table-dark th {
      color: var(--texto-claro);
    }
    /* BOTONES */
    .btn-primary {
      background-color: var(--azul-turquesa);
      border-color: var(--azul-turquesa);
    }
    .btn-primary:hover {
      background-color: var(--grana);
      border-color: var(--grana);
    }
    .btn-danger:hover {
      background-color: #a00;
    }
    .btn-warning:hover {
      background-color: #cc8c00;
    }
    /* FOOTER */
    .footer {
      background-color: var(--azul-turquesa);
      color: var(--texto-claro);
      padding: 2rem 0;
      text-align: center;
    }
    .footer a {
      color: var(--texto-claro);
      text-decoration: none;
    }
    .footer a:hover {
      text-decoration: underline;
      color: var(--dorado);
    }
  </style>
</head>
<body>
  <!-- Botón Volver Arriba -->
  <button id="btnBackToTop" title="Volver arriba">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top transparent">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="escudo.jpg" alt="Logo DIBA FBC" />
        DIBA FBC
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link active" href="Historia.html">Historia</a></li>
          <li class="nav-item"><a class="nav-link" href="ficha.html">Ficha Técnica</a></li>
          <li class="nav-item"><a class="nav-link" href="planillas.html">Planillas</a></li>
          <li class="nav-item"><a class="nav-link" href="NormasyReglamentos.html">Normas y Reglamentos</a></li>
          <li class="nav-item"><a class="nav-link" href="partidos.html">Partidos</a></li>
          <li class="nav-item"><a class="nav-link" href="#contacto">Contacto</a></li>
        </ul>
      </div>
    </div>
  </nav>


  <!-- HERO -->
  <section class="hero animate__animated animate__fadeInDown">
    <div class="hero-content container">
      <h1 class="hero-title">UNA SOLA FAMILIA</h1>
      <p class="hero-subtitle">FUERZA Y LEALTAD</p>
    </div>
  </section>

  <!-- SECCIÓN CRUD -->
  <div class="container mb-5">
    <h2 class="text-center mb-4">CRUD - Jugadores Sin Sensibles</h2>
    <!-- Botón para agregar nuevo jugador -->
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalForm">
      <i class="fa fa-plus"></i> Agregar Nuevo
    </button>
    <!-- Sección para actualizar desde Excel -->
    <div class="mb-3">
      <label class="form-label fw-bold">Actualizar desde Excel:</label>
      <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="form-control" />
      <button class="btn btn-success mt-2" onclick="actualizarDesdeExcel()">
        <i class="fa fa-upload"></i> Subir Excel
      </button>
    </div>
    <!-- Tabla para mostrar registros con animación de entrada -->
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle animate__animated animate__fadeInUp">
        <thead class="table-dark">
          <tr>
            <th>Email</th>
            <th>Nombres</th>
            <th>Apellidos</th>
            <th>Edad</th>
            <th>Tipo Documento</th>
            <th>Fecha Nacimiento</th>
            <th>Barrio</th>
            <th>Nombre Acudiente</th>
            <th>Apellido Acudiente</th>
            <th>Parentesco</th>
            <th>Correo Acudiente</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-datos"></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL FORMULARIO (CRUD) -->
  <div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Datos del Jugador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Campo oculto para almacenar el email original (para identificar el registro en edición) -->
          <input type="hidden" id="originalEmail" />
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">Email</label>
              <input type="email" class="form-control" id="email" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Nombres</label>
              <input type="text" class="form-control" id="nombres" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Apellidos</label>
              <input type="text" class="form-control" id="apellidos" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Edad</label>
              <input type="number" class="form-control" id="edad" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Tipo de Documento</label>
              <input type="text" class="form-control" id="tipo_documento" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Fecha de Nacimiento</label>
              <input type="date" class="form-control" id="fecha_nacimiento" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Barrio</label>
              <input type="text" class="form-control" id="barrio" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Nombre Acudiente</label>
              <input type="text" class="form-control" id="nombre_acudiente" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Apellido Acudiente</label>
              <input type="text" class="form-control" id="apellido_acudiente" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Parentesco</label>
              <input type="text" class="form-control" id="parentesco" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Correo Acudiente</label>
              <input type="email" class="form-control" id="correo_acudiente" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE CONFIGURACIÓN (para actualizar colorimetría sin editar el código) -->
  <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Configuración de Colorimetría</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Color Fondo</label>
            <input type="color" id="colorFondo" class="form-control form-control-color" value="#2C2C2C">
          </div>
          <div class="mb-3">
            <label class="form-label">Color Navbar</label>
            <input type="color" id="colorNavbar" class="form-control form-control-color" value="#004D73">
          </div>
          <div class="mb-3">
            <label class="form-label">Color Texto Claro</label>
            <input type="color" id="colorTextoClaro" class="form-control form-control-color" value="#ffffff">
          </div>
          <div class="mb-3">
            <label class="form-label">Color Dorado</label>
            <input type="color" id="colorDorado" class="form-control form-control-color" value="#FFD700">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" onclick="aplicarConfiguracion()">Aplicar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 DIBA FBC. Todos los derechos reservados.</p>
      <p>
        <a href="#">Políticas de Privacidad</a> |
        <a href="#">Términos de Uso</a>
      </p>
    </div>
  </footer>

  <!-- BOOTSTRAP JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Configuración de Supabase: Reemplaza con tus datos reales
    const SUPABASE_URL = "TU_SUPABASE_URL";
    const SUPABASE_KEY = "TU_SUPABASE_KEY";
    const TABLE_NAME = "jugadores_sin_sensibles";

    const headers = {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    };

    // Al cargar la página
    document.addEventListener("DOMContentLoaded", cargarDatos);
    document.getElementById("btnGuardar").addEventListener("click", guardar);

    // Función para cargar registros desde Supabase
    async function cargarDatos() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`, { headers });
        const datos = await res.json();
        mostrarEnTabla(datos);
      } catch (error) {
        console.error("Error al cargar datos:", error);
      }
    }

    // Muestra los registros en la tabla HTML (añadiendo animación en cada fila)
    function mostrarEnTabla(datos) {
      const tbody = document.getElementById("tabla-datos");
      tbody.innerHTML = "";
      datos.forEach((d, i) => {
        const tr = document.createElement("tr");
        // Agregamos clase de animación delay usando animate__delay-{n}s (hasta 5s disponible)
        tr.classList.add("animate__animated", "animate__fadeInUp");
        tr.style.animationDelay = `${Math.min(i * 0.1, 1)}s`;
        tr.innerHTML = `
          <td>${d.email ?? ""}</td>
          <td>${d.nombres ?? ""}</td>
          <td>${d.apellidos ?? ""}</td>
          <td>${d.edad ?? ""}</td>
          <td>${d.tipo_documento ?? ""}</td>
          <td>${d.fecha_nacimiento ?? ""}</td>
          <td>${d.barrio ?? ""}</td>
          <td>${d.nombre_acudiente ?? ""}</td>
          <td>${d.apellido_acudiente ?? ""}</td>
          <td>${d.parentesco ?? ""}</td>
          <td>${d.correo_acudiente ?? ""}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick='editar(${JSON.stringify(d)})'>
              <i class="fa fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick='eliminar("${d.email}")'>
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Abre el modal para editar un registro
    function editar(d) {
      document.getElementById("originalEmail").value = d.email || "";
      document.getElementById("email").value = d.email || "";
      document.getElementById("nombres").value = d.nombres || "";
      document.getElementById("apellidos").value = d.apellidos || "";
      document.getElementById("edad").value = d.edad || "";
      document.getElementById("tipo_documento").value = d.tipo_documento || "";
      document.getElementById("fecha_nacimiento").value = d.fecha_nacimiento || "";
      document.getElementById("barrio").value = d.barrio || "";
      document.getElementById("nombre_acudiente").value = d.nombre_acudiente || "";
      document.getElementById("apellido_acudiente").value = d.apellido_acudiente || "";
      document.getElementById("parentesco").value = d.parentesco || "";
      document.getElementById("correo_acudiente").value = d.correo_acudiente || "";
      new bootstrap.Modal(document.getElementById("modalForm")).show();
    }

    // Guarda (crea o edita) un registro
    async function guardar() {
      const originalEmail = document.getElementById("originalEmail").value;
      const email = document.getElementById("email").value.trim();
      const nombres = document.getElementById("nombres").value.trim();
      const apellidos = document.getElementById("apellidos").value.trim();
      const edad = parseInt(document.getElementById("edad").value || 0);
      const tipo_documento = document.getElementById("tipo_documento").value.trim();
      const fecha_nacimiento = document.getElementById("fecha_nacimiento").value;
      const barrio = document.getElementById("barrio").value.trim();
      const nombre_acudiente = document.getElementById("nombre_acudiente").value.trim();
      const apellido_acudiente = document.getElementById("apellido_acudiente").value.trim();
      const parentesco = document.getElementById("parentesco").value.trim();
      const correo_acudiente = document.getElementById("correo_acudiente").value.trim();

      const body = {
        email,
        nombres,
        apellidos,
        edad,
        tipo_documento,
        fecha_nacimiento,
        barrio,
        nombre_acudiente,
        apellido_acudiente,
        parentesco,
        correo_acudiente
      };

      try {
        if (!originalEmail) {
          // Crear nuevo registro
          await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}`, {
            method: "POST",
            headers,
            body: JSON.stringify(body)
          });
        } else {
          // Actualizar registro existente (identificado por originalEmail)
          await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}?email=eq.${encodeURIComponent(originalEmail)}`, {
            method: "PATCH",
            headers,
            body: JSON.stringify(body)
          });
        }
        document.querySelector("#modalForm .btn-close").click();
        limpiarFormulario();
        cargarDatos();
      } catch (error) {
        console.error("Error al guardar:", error);
      }
    }

    // Elimina un registro
    async function eliminar(email) {
      if (!confirm("¿Seguro que deseas eliminar este registro?")) return;
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}?email=eq.${encodeURIComponent(email)}`, {
          method: "DELETE",
          headers
        });
        cargarDatos();
      } catch (error) {
        console.error("Error al eliminar:", error);
      }
    }

    // Limpia el formulario
    function limpiarFormulario() {
      document.getElementById("originalEmail").value = "";
      document.getElementById("email").value = "";
      document.getElementById("nombres").value = "";
      document.getElementById("apellidos").value = "";
      document.getElementById("edad").value = "";
      document.getElementById("tipo_documento").value = "";
      document.getElementById("fecha_nacimiento").value = "";
      document.getElementById("barrio").value = "";
      document.getElementById("nombre_acudiente").value = "";
      document.getElementById("apellido_acudiente").value = "";
      document.getElementById("parentesco").value = "";
      document.getElementById("correo_acudiente").value = "";
    }

    // Función para actualizar registros desde un archivo Excel
    async function actualizarDesdeExcel() {
      const fileInput = document.getElementById("excelFileInput");
      const file = fileInput.files[0];
      if (!file) {
        alert("Por favor, selecciona un archivo Excel.");
        return;
      }
      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        const headersExcel = jsonData[0];
        const records = [];
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          let record = {};
          headersExcel.forEach((header, index) => {
            record[header] = row[index];
          });
          records.push(record);
        }
        // Procesar cada registro (usando 'Dirección de correo electrónico' como identificador)
        for (let rec of records) {
          let body = {
            email: rec['Dirección de correo electrónico'] || "",
            nombres: rec['Nombres'] || "",
            apellidos: rec['Apellidos'] || "",
            edad: parseInt(rec['Edad'] || "0"),
            tipo_documento: rec['Tipo De Documento'] || "",
            fecha_nacimiento: formatExcelDate(rec['Fecha de nacimiento']),
            barrio: rec['Barrio'] || "",
            nombre_acudiente: rec['Nombre del padre, madre o acudiente'] || "",
            apellido_acudiente: rec['Apellido del padre, madre o acudiente'] || "",
            parentesco: rec['Parentesco con el niño'] || "",
            correo_acudiente: rec['Correo electrónico'] || ""
          };
          await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}?email=eq.${encodeURIComponent(body.email)}`, {
            method: "PATCH",
            headers,
            body: JSON.stringify(body)
          });
        }
        alert("Actualización desde Excel completada.");
        cargarDatos();
      };
      reader.readAsArrayBuffer(file);
    }

    // Helper: Convierte fecha de Excel a formato ISO (YYYY-MM-DD)
    function formatExcelDate(excelDate) {
      if (typeof excelDate === 'number') {
        let utc_days = Math.floor(excelDate - 25569);
        let utc_value = utc_days * 86400;
        let date = new Date(utc_value * 1000);
        return date.toISOString().split('T')[0];
      }
      if (typeof excelDate === 'string') {
        const parts = excelDate.split(/[\\/\\-]/);
        if (parts.length === 3) {
          return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }
      }
      return excelDate;
    }

    // PANEL DE CONFIGURACIÓN: Aplica la nueva colorimetría a través de variables CSS
    function aplicarConfiguracion() {
      const colorFondo = document.getElementById("colorFondo").value;
      const colorNavbar = document.getElementById("colorNavbar").value;
      const colorTextoClaro = document.getElementById("colorTextoClaro").value;
      const colorDorado = document.getElementById("colorDorado").value;

      // Actualizamos las variables CSS en :root
      document.documentElement.style.setProperty("--bg-patron", colorFondo);
      document.documentElement.style.setProperty("--azul-turquesa", colorNavbar);
      document.documentElement.style.setProperty("--texto-claro", colorTextoClaro);
      document.documentElement.style.setProperty("--dorado", colorDorado);

      // Actualizar elementos relevantes (opcional, ya que CSS se actualiza automáticamente)
      alert("Configuración aplicada.");
      new bootstrap.Modal(document.getElementById("configModal")).hide();
    }
  </script>
</body>
</html>
