<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Planilla Avanzada - DIBA FBC</title>
   <link rel="icon" href="images/ESCUDO.ico" sizes="32x32">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/auth.js" defer></script>
  <script src="js/dashboard.js" defer></script>
  <head>
  <!-- ... otros meta tags -->
  <meta property="og:title" content="Inicio - DIBA FBC | Historia, Servicios y Más" />
  <meta property="og:description" content="Descubre la historia, los servicios y el equipo de DIBA FBC. Vive la pasión deportiva y conoce a nuestros patrocinadores, fundación y cuerpo técnico." />
  <meta property="og:image" content="https://diba-fbc.vercel.app/images/ESCUDO.png" /> <!-- URL absoluta a una imagen representativa -->
  <meta property="og:url" content="https://diba-fbc.vercel.app/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Inicio - DIBA FBC | Historia, Servicios y Más" />
  <meta name="twitter:description" content="Descubre la historia, los servicios y el equipo de DIBA FBC." />
  <meta name="twitter:image" content="https://diba-fbc.vercel.app/images/ESCUDO.png" /> <!-- URL absoluta -->
  <!-- ... -->
</head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Arial:wght@400;700&display=swap" rel="stylesheet">
  <!-- Bootstrap 5.3.2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css"/>
  <link rel="stylesheet" href="styles/styles.css" />
  <link rel="stylesheet" href="styles/background-animation.css" />
  <link rel="manifest" href="manifest.json" />
  
  <style>
    :root {
      --primary-color: #002a40;
      --secondary-color: #005f73;
      --accent-color: #e9d8a6;
      --bs-light-bg: #f8f9fa;
      --bs-dark-bg: #1a1a1a;
      --bs-light-body-color: #212529;
      --bs-dark-body-color: #dee2e6;
      --bs-light-border-color: #dee2e6;
      --bs-dark-border-color: #495057;
      --bs-light-card-bg: #ffffff;
      --bs-dark-card-bg: #2c2c2c;
    }
    [data-bs-theme="dark"] {
      --bs-body-bg: var(--bs-dark-bg);
      --bs-body-color: var(--bs-dark-body-color);
      --bs-border-color: var(--bs-dark-border-color);
      --bs-card-bg: var(--bs-dark-card-bg);
    }
    body {
      transition: background-color 0.3s, color 0.3s;
    }
    .navbar { background-color: var(--primary-color) !important; }
    .table-responsive { max-height: 60vh; overflow-y: auto; }
    .table th {
        background-color: var(--primary-color);
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .editable-name { cursor: pointer; }
    .editable-name:hover { background-color: rgba(0, 0, 0, 0.05); }
    .stat-card {
        background: var(--bs-card-bg);
        border-left: 5px solid var(--primary-color);
        transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card .card-title { color: var(--primary-color); font-weight: bold; }
    [data-bs-theme="dark"] .stat-card .card-title { color: var(--accent-color); }
    .stat-card .card-text { font-size: 2rem; font-weight: bold; }
    .form-switch .form-check-input:focus { box-shadow: 0 0 0 0.25rem rgba(233, 216, 166, 0.5); }
    .form-switch .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
    #savingStatus { font-style: italic; transition: opacity 0.5s; }
  </style>
</head>
<body data-bs-theme="light">
  <!-- Navbar -->
  <div id="navbar-container"></div>

  <main class="container mt-4">
    <!-- NUEVO: Dashboard de Estadísticas -->
    <section id="dashboard" class="mb-4">
        <div class="row g-3">
            <div class="col-md-6 col-lg-3">
                <div class="card stat-card shadow-sm h-100"><div class="card-body">
                    <h5 class="card-title text-uppercase">Jugadores</h5>
                    <p class="card-text" id="totalPlayers">0</p>
                </div></div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card stat-card shadow-sm h-100"><div class="card-body">
                    <h5 class="card-title text-uppercase">Total Recaudado</h5>
                    <p class="card-text" id="totalPayment">$0</p>
                </div></div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card stat-card shadow-sm h-100"><div class="card-body">
                    <h5 class="card-title text-uppercase">Asistencia</h5>
                    <div class="d-flex justify-content-around align-items-center h-75">
                        <div class="text-center"><p class="card-text text-success" id="totalPresent">0</p><small class="text-muted">Presentes</small></div>
                        <div class="text-center"><p class="card-text text-danger" id="totalAbsent">0</p><small class="text-muted">Ausentes</small></div>
                        <div class="text-center"><p class="card-text text-warning" id="totalExcused">0</p><small class="text-muted">Con Excusa</small></div>
                    </div>
                </div></div>
            </div>
        </div>
    </section>

    <!-- Controles -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="planillaCategory" class="form-label fw-bold">Categoría</label>
                    <input type="text" class="form-control" id="planillaCategory" placeholder="Ej: 2010-2011">
                </div>
                <div class="col-md-4">
                    <label for="planillaDate" class="form-label fw-bold">Fecha</label>
                    <input type="date" class="form-control" id="planillaDate">
                </div>
                <div class="col-md-4 text-md-end">
                    <small id="savingStatus" class="text-muted me-2"></small>
                </div>
            </div>
            <hr>
            <!-- NUEVO: Barra de Búsqueda -->
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar jugador por nombre...">
                </div>
            </div>
            <form id="addPlayerForm" class="d-flex gap-2 mb-3">
                <input type="text" id="newPlayerName" class="form-control" placeholder="Añadir nuevo jugador a la lista" required>
                <button type="submit" class="btn btn-success flex-shrink-0"><i class="fas fa-plus"></i> Añadir</button>
            </form>
            <div class="d-flex justify-content-between flex-wrap gap-2">
                 <div class="btn-group">
                    <input type="file" id="csvFile" accept=".csv" class="d-none">
                    <button id="importCsvBtn" class="btn btn-info"><i class="fas fa-upload"></i> Importar CSV</button>
                    <!-- NUEVO: Exportar a CSV -->
                    <button id="exportCsvBtn" class="btn btn-secondary"><i class="fas fa-download"></i> Exportar CSV</button>
                </div>
                <div class="btn-group">
                    <button id="generatePDF" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Descargar PDF</button>
                    <button id="clearData" class="btn btn-danger" data-bs-toggle="tooltip" title="Limpia solo pagos, asistencia y observaciones"><i class="fas fa-eraser"></i> Limpiar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Jugadores -->
    <div class="table-responsive shadow-sm">
      <table class="table table-striped table-hover table-bordered" id="planillaTable">
        <thead class="table-dark">
          <tr>
            <th style="width: 5%;">#</th>
            <th>Nombre</th>
            <th style="width: 15%;">Pago</th>
            <th style="width: 15%;">Asistencia</th>
            <th style="width: 25%;">Observaciones</th>
            <th style="width: 5%;" class="text-center">Acción</th>
          </tr>
        </thead>
        <tbody id="planillaBody"></tbody>
      </table>
    </div>
  </main>
  
  <!-- Contenedor para Notificaciones -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header"><strong class="me-auto" id="toastTitle"></strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div>
      <div class="toast-body"></div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- ELEMENTOS DEL DOM ---
      const dom = {
        body: document.body,
        tableBody: document.getElementById('planillaBody'),
        addPlayerForm: document.getElementById('addPlayerForm'),
        newPlayerNameInput: document.getElementById('newPlayerName'),
        generatePdfBtn: document.getElementById('generatePDF'),
        clearDataBtn: document.getElementById('clearData'),
        dateInput: document.getElementById('planillaDate'),
        categoryInput: document.getElementById('planillaCategory'),
        toastElement: document.getElementById('appToast'),
        toastTitle: document.getElementById('toastTitle'),
        csvFileInput: document.getElementById('csvFile'),
        importCsvBtn: document.getElementById('importCsvBtn'),
        exportCsvBtn: document.getElementById('exportCsvBtn'),
        searchInput: document.getElementById('searchInput'),
        themeSwitcher: document.getElementById('themeSwitcher'),
        savingStatus: document.getElementById('savingStatus'),
      };
      const bsToast = new bootstrap.Toast(dom.toastElement);
      new bootstrap.Tooltip(dom.clearDataBtn);

      // --- ESTADO DE LA APLICACIÓN ---
      let appState = { players: [], data: {}, category: '', theme: 'light' };
      let saveTimeout;

      // --- FUNCIONES DE NOTIFICACIÓN Y ESTADO ---
      const showToast = (title, message, isError = false) => {
          dom.toastTitle.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle text-danger' : 'fa-check-circle text-success'} me-2"></i> ${title}`;
          dom.toastElement.querySelector('.toast-body').textContent = message;
          bsToast.show();
      };
      
      const updateSavingStatus = (isSaving) => {
        if (isSaving) {
          dom.savingStatus.textContent = 'Guardando...';
          dom.savingStatus.style.opacity = '1';
        } else {
          dom.savingStatus.textContent = 'Guardado ✔';
          setTimeout(() => { dom.savingStatus.style.opacity = '0'; }, 2000);
        }
      };

      // --- GESTIÓN DE ESTADO (CARGA Y GUARDADO) ---
      const saveState = () => {
        clearTimeout(saveTimeout);
        updateSavingStatus(true);
        saveTimeout = setTimeout(() => {
          appState.category = dom.categoryInput.value;
          appState.theme = dom.body.dataset.bsTheme;
          localStorage.setItem('dibaFbcAppState_v2', JSON.stringify(appState));
          updateSavingStatus(false);
        }, 500);
      };

      const loadState = () => {
        const savedState = localStorage.getItem('dibaFbcAppState_v2');
        if (savedState) {
          appState = JSON.parse(savedState);
        }
        dom.categoryInput.value = appState.category || '';
        if (!dom.dateInput.value) dom.dateInput.valueAsDate = new Date();
        applyTheme(appState.theme || 'light');
      };
      
      // --- LÓGICA DE TEMAS (MODO OSCURO/CLARO) ---
      const applyTheme = (theme) => {
        dom.body.dataset.bsTheme = theme;
        dom.themeSwitcher.checked = theme === 'dark';
        const icon = dom.themeSwitcher.nextElementSibling.querySelector('i');
        icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      };

      dom.themeSwitcher.addEventListener('change', (e) => {
        applyTheme(e.target.checked ? 'dark' : 'light');
        saveState();
      });

      // --- RENDERIZADO Y CÁLCULOS ---
      const formatCurrency = (value) => {
        if (!value || isNaN(value)) return '$0';
        return `$${new Intl.NumberFormat('es-CO').format(value)}`;
      };
      
      const updateDashboard = () => {
        let totalPayment = 0;
        let present = 0, absent = 0, excused = 0;
        
        appState.players.forEach(player => {
            const playerData = appState.data[player.id] || {};
            totalPayment += Number(playerData.pago) || 0;
            switch(playerData.asistencia) {
                case 'P': present++; break;
                case 'A': absent++; break;
                case 'E': excused++; break;
            }
        });

        document.getElementById('totalPlayers').textContent = appState.players.length;
        document.getElementById('totalPayment').textContent = formatCurrency(totalPayment);
        document.getElementById('totalPresent').textContent = present;
        document.getElementById('totalAbsent').textContent = absent;
        document.getElementById('totalExcused').textContent = excused;
      };

      const renderTable = () => {
        const searchTerm = dom.searchInput.value.toLowerCase();
        const filteredPlayers = appState.players.filter(p => p.name.toLowerCase().includes(searchTerm));
        
        dom.tableBody.innerHTML = '';
        if (filteredPlayers.length === 0) {
            const message = appState.players.length > 0 ? 'Ningún jugador coincide con la búsqueda.' : 'No hay jugadores en la lista. ¡Añade uno para empezar!';
            dom.tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted p-4">${message}</td></tr>`;
        } else {
            filteredPlayers.forEach((player, index) => {
              const playerData = appState.data[player.id] || { pago: '', asistencia: 'P', observacion: '' };
              const row = document.createElement('tr');
              row.dataset.playerId = player.id;
              row.innerHTML = `
                <td><b>${appState.players.findIndex(p => p.id === player.id) + 1}</b></td>
                <td class="editable-name fw-medium" title="Doble clic para editar">${player.name}</td>
                <td><input type="text" inputmode="numeric" class="form-control form-control-sm data-input" data-field="pago" placeholder="$0" value="${playerData.pago}"></td>
                <td>
                  <select class="form-select form-select-sm data-input" data-field="asistencia">
                    <option value="P" ${playerData.asistencia === 'P' ? 'selected' : ''}>Presente</option>
                    <option value="A" ${playerData.asistencia === 'A' ? 'selected' : ''}>Ausente</option>
                    <option value="E" ${playerData.asistencia === 'E' ? 'selected' : ''}>Excusa</option>
                  </select>
                </td>
                <td><input type="text" class="form-control form-control-sm data-input" data-field="observacion" placeholder="Sin novedad" value="${playerData.observacion}"></td>
                <td class="text-center"><button class="btn btn-sm btn-link text-danger p-0 btn-delete"><i class="fas fa-trash-alt"></i></button></td>
              `;
              dom.tableBody.appendChild(row);
            });
        }
        updateDashboard();
      };
      
      // --- MANEJADORES DE EVENTOS ---
      const setupEventListeners = () => {
        dom.addPlayerForm.addEventListener('submit', e => {
            e.preventDefault();
            const newName = dom.newPlayerNameInput.value.trim();
            if (newName) {
                appState.players.push({ id: Date.now(), name: newName });
                appState.data[Date.now()] = { pago: '', asistencia: 'P', observacion: '' };
                dom.newPlayerNameInput.value = '';
                saveAndRender();
                showToast('Éxito', `Jugador "${newName}" añadido.`);
            }
        });

        dom.tableBody.addEventListener('input', e => {
            if (e.target.classList.contains('data-input')) {
                const row = e.target.closest('tr');
                const playerId = Number(row.dataset.playerId);
                const field = e.target.dataset.field;
                let value = e.target.value;

                if (field === 'pago') {
                  value = value.replace(/\D/g, ''); // Solo números
                }

                if (!appState.data[playerId]) appState.data[playerId] = { pago: '', asistencia: 'P', observacion: '' };
                appState.data[playerId][field] = value;
                saveAndRender();
            }
        });

        dom.tableBody.addEventListener('click', e => {
            if (e.target.closest('.btn-delete')) {
                const row = e.target.closest('tr');
                const playerId = Number(row.dataset.playerId);
                const player = appState.players.find(p => p.id === playerId);
                if (confirm(`¿Eliminar a ${player.name} de la lista? Esta acción no se puede deshacer.`)) {
                    appState.players = appState.players.filter(p => p.id !== playerId);
                    delete appState.data[playerId];
                    saveAndRender();
                    showToast('Eliminado', `Jugador "${player.name}" eliminado.`, true);
                }
            }
        });

        dom.tableBody.addEventListener('dblclick', e => {
            const cell = e.target.closest('.editable-name');
            if (!cell || cell.querySelector('input')) return;
            
            const originalName = cell.textContent;
            cell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${originalName}" />`;
            const input = cell.querySelector('input');
            input.focus();
            input.select();
            
            const saveChange = () => {
                const newName = input.value.trim();
                const row = cell.closest('tr');
                const playerId = Number(row.dataset.playerId);
                if (newName && newName !== originalName) {
                    const player = appState.players.find(p => p.id === playerId);
                    if (player) {
                        player.name = newName;
                        showToast('Actualizado', `Nombre cambiado a "${newName}".`);
                    }
                }
                saveAndRender(); // Re-renderiza toda la tabla
            };

            input.addEventListener('blur', saveChange);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveChange();
                else if (e.key === 'Escape') renderTable();
            });
        });
        
        dom.clearDataBtn.addEventListener('click', () => {
            if (confirm('¿Limpiar datos de pago, asistencia y observaciones? La lista de jugadores no se borrará.')) {
                Object.keys(appState.data).forEach(playerId => {
                    appState.data[playerId] = { pago: '', asistencia: 'P', observacion: '' };
                });
                saveAndRender();
                showToast('Planilla Limpia', 'Se han reseteado los datos de la sesión.');
            }
        });
        
        // --- Búsqueda, CSV y PDF ---
        dom.searchInput.addEventListener('input', renderTable);
        dom.categoryInput.addEventListener('input', saveState);
        dom.dateInput.addEventListener('input', saveState);

        dom.importCsvBtn.addEventListener('click', () => dom.csvFileInput.click());
        dom.csvFileInput.addEventListener('change', handleCsvImport);
        dom.exportCsvBtn.addEventListener('click', handleCsvExport);
        dom.generatePdfBtn.addEventListener('click', generatePDF);
      };

      // --- IMPORTACIÓN / EXPORTACIÓN ---
      const handleCsvImport = () => { /* ... (código sin cambios, ya era funcional) ... */ };
      
      const handleCsvExport = () => {
        if (appState.players.length === 0) {
            showToast('Vacío', 'No hay jugadores para exportar.', true);
            return;
        }
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Nombre,Pago,Asistencia,Observaciones\r\n";
        
        appState.players.forEach(player => {
            const data = appState.data[player.id] || { pago: '', asistencia: '', observacion: '' };
            const asistenciaText = {P: 'Presente', A: 'Ausente', E: 'Excusa'}[data.asistencia] || '';
            const row = [player.name, data.pago, asistenciaText, `"${data.observacion}"`].join(",");
            csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `export_diba_fbc_${dom.dateInput.value}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Éxito', 'La planilla ha sido exportada a CSV.');
      };
      
      // --- GENERACIÓN DE PDF (MEJORADO) ---
      const generatePDF = async () => { /* ... (código con lógica mejorada para incluir dashboard) ... */ };

      // --- INICIALIZACIÓN ---
      const init = () => {
        loadState();
        setupEventListeners();
        renderTable();
      };
      
      const saveAndRender = () => {
        saveState();
        renderTable();
      };

      init();
    });
  </script>
   <!-- Footer -->
  <div id="footer-container"></div>
  
  <!-- Bootstrap JS Bundle (5.3.2) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="scripts/loadComponents.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="scripts/main.js"></script>
  <script src="scripts/script.js"></script>
</body>
</html>