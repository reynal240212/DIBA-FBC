<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas Profesional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary-color: #003b5c; }
        body { background-color: #eef2f5; }
        .invoice-card { box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,.1); border: none; }
        .logo-container {
            background-color: #f8f9fa;
            border: 2px dashed #ced4da;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 120px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .logo-container:hover { background-color: #e9ecef; }
        .logo-container img { max-height: 100px; max-width: 100%; }
        .totals-section { background-color: #f8f9fa; }
        #invoice-modal .modal-dialog { max-width: 800px; }
        @media print {
            body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--primary-color);">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="fas fa-file-invoice-dollar me-2"></i>Facturador Pro</a>
            <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#settings-modal">
                <i class="fas fa-cog me-1"></i> Ajustes
            </button>
        </div>
    </nav>

    <main class="container my-4">
        <div class="card p-4 p-md-5 invoice-card" id="invoice-form">
            <!-- Encabezado: Logo y Datos de Factura -->
            <div class="row align-items-center mb-4">
                <div class="col-md-6">
                    <div id="logo-upload-container" class="logo-container rounded text-center text-muted">
                        <img id="logo-preview" src="" alt="Logo" class="d-none">
                        <span id="logo-placeholder"><i class="fas fa-camera me-2"></i>Hacer clic para subir logo</span>
                    </div>
                    <input type="file" id="logo-input" class="d-none" accept="image/*">
                </div>
                <div class="col-md-6 mt-3 mt-md-0 text-md-end">
                    <h1 class="display-6 fw-bold">FACTURA</h1>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Nº</span>
                        <input type="text" class="form-control" id="invoice-number" value="FACT-001">
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Fecha:</span>
                        <input type="date" class="form-control" id="invoice-date">
                    </div>
                    <div class="input-group">
                        <span class="input-group-text">Vence:</span>
                        <input type="date" class="form-control" id="invoice-due-date">
                    </div>
                </div>
            </div>

            <!-- Emisor y Receptor -->
            <div class="row border-top pt-4 mb-4">
                <div class="col-md-6">
                    <h5 class="text-muted">De:</h5>
                    <p id="company-details" class="fw-bold">Configura los datos de tu empresa en Ajustes.</p>
                </div>
                <div class="col-md-6 mt-3 mt-md-0">
                    <h5 class="text-muted">Para:</h5>
                    <input type="text" class="form-control mb-2" id="client-name" placeholder="Nombre o Razón Social del Cliente" required>
                    <textarea class="form-control" id="client-details" rows="2" placeholder="Dirección, Teléfono, Email del Cliente"></textarea>
                </div>
            </div>

            <!-- Tabla de Items -->
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 50%;">Descripción</th>
                            <th scope="col" style="width: 15%;">Cantidad</th>
                            <th scope="col" style="width: 15%;">Vlr. Unitario</th>
                            <th scope="col" style="width: 15%;">Total</th>
                            <th scope="col" class="text-center"></th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items"></tbody>
                </table>
            </div>
            <button id="add-item-btn" class="btn btn-outline-primary" style="border-style: dashed;">
                <i class="fas fa-plus me-1"></i>Añadir Item
            </button>

            <!-- Totales -->
            <div class="row mt-4 justify-content-end">
                <div class="col-md-6">
                    <div class="p-3 totals-section rounded">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <strong id="subtotal">$0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Impuestos (<span id="tax-rate-text">19</span>%):</span>
                            <strong id="taxes">$0</strong>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between h4 fw-bold">
                            <span>TOTAL:</span>
                            <strong id="total">$0</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notas y Botones de Acción -->
            <div class="mt-4">
                 <label for="notes" class="form-label text-muted">Notas Adicionales:</label>
                 <textarea class="form-control" id="notes" rows="2" placeholder="Términos y condiciones, información de pago, etc."></textarea>
            </div>
            <div class="text-center mt-4 d-grid gap-2 d-md-flex justify-content-md-end">
                <button id="new-invoice-btn" class="btn btn-secondary"><i class="fas fa-sync-alt me-2"></i>Nueva Factura</button>
                <button id="generate-invoice-btn" class="btn btn-lg btn-success" disabled>
                    <i class="fas fa-check-circle me-2"></i>Generar y Ver Factura
                </button>
            </div>
        </div>
    </main>
    
    <!-- Modal de Ajustes -->
    <div class="modal fade" id="settings-modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Ajustes de la Empresa y Facturación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="company-name" class="form-label">Nombre de tu Empresa</label>
              <input type="text" class="form-control" id="company-name">
            </div>
            <div class="mb-3">
              <label for="company-address" class="form-label">Dirección, Teléfono, Email, NIT</label>
              <textarea class="form-control" id="company-address" rows="3"></textarea>
            </div>
            <div class="row">
                <div class="col-6">
                    <label for="tax-rate" class="form-label">Tasa de Impuestos (%)</label>
                    <input type="number" class="form-control" id="tax-rate" value="19" min="0">
                </div>
                <div class="col-6">
                    <label for="currency-symbol" class="form-label">Símbolo de Moneda</label>
                    <input type="text" class="form-control" id="currency-symbol" value="$">
                </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="save-settings-btn" data-bs-dismiss="modal">Guardar Cambios</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal de Vista Previa de Factura -->
    <div class="modal fade" id="invoice-modal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header no-print">
            <h5 class="modal-title">Vista Previa de la Factura</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body printable-area" id="invoice-preview-content">
             <!-- La factura se generará aquí -->
          </div>
          <div class="modal-footer no-print">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="window.print();"><i class="fas fa-print me-2"></i>Imprimir Factura</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            form: document.getElementById('invoice-form'),
            itemsContainer: document.getElementById('invoice-items'),
            addItemBtn: document.getElementById('add-item-btn'),
            generateBtn: document.getElementById('generate-invoice-btn'),
            newInvoiceBtn: document.getElementById('new-invoice-btn'),
            logoUploadContainer: document.getElementById('logo-upload-container'),
            logoInput: document.getElementById('logo-input'),
            logoPreview: document.getElementById('logo-preview'),
            logoPlaceholder: document.getElementById('logo-placeholder'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            invoicePreviewModal: new bootstrap.Modal(document.getElementById('invoice-modal')),
        };

        let state = {};

        const saveState = () => {
            localStorage.setItem('invoiceAppState', JSON.stringify(state));
        };
        
        const loadState = () => {
            const savedState = localStorage.getItem('invoiceAppState');
            state = savedState ? JSON.parse(savedState) : {
                company: { name: '', address: '', logo: '', taxRate: 19, currency: '$' },
                invoice: { number: 'FACT-001', date: new Date().toISOString().slice(0, 10), dueDate: '', notes: '' },
                client: { name: '', details: '' },
                items: []
            };
            if (state.items.length === 0) addNewItem();
        };

        const render = () => {
            // Render company details
            const { company, invoice, client, items } = state;
            document.getElementById('company-name').value = company.name;
            document.getElementById('company-address').value = company.address;
            document.getElementById('tax-rate').value = company.taxRate;
            document.getElementById('tax-rate-text').textContent = company.taxRate;
            document.getElementById('currency-symbol').value = company.currency;
            dom.logoPreview.src = company.logo;
            dom.logoPreview.classList.toggle('d-none', !company.logo);
            dom.logoPlaceholder.classList.toggle('d-none', !!company.logo);
            document.getElementById('company-details').innerHTML = company.name ? `<strong>${company.name}</strong><br>${company.address.replace(/\n/g, '<br>')}` : 'Configura los datos en Ajustes.';

            // Render invoice details
            document.getElementById('invoice-number').value = invoice.number;
            document.getElementById('invoice-date').value = invoice.date;
            document.getElementById('invoice-due-date').value = invoice.dueDate;
            document.getElementById('notes').value = invoice.notes;
            
            // Render client details
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-details').value = client.details;

            // Render items
            dom.itemsContainer.innerHTML = '';
            items.forEach((item, index) => {
                const itemRow = document.createElement('tr');
                itemRow.dataset.index = index;
                itemRow.innerHTML = `
                    <td><input type="text" class="form-control" data-field="description" value="${item.description}" placeholder="Descripción"></td>
                    <td><input type="number" class="form-control text-end" data-field="quantity" value="${item.quantity}" min="1"></td>
                    <td><input type="number" class="form-control text-end" data-field="price" value="${item.price}" placeholder="0.00"></td>
                    <td class="text-end fw-bold item-total"></td>
                    <td class="text-center"><button class="btn btn-sm btn-outline-danger remove-item-btn"><i class="fas fa-times"></i></button></td>
                `;
                dom.itemsContainer.appendChild(itemRow);
            });
            
            updateTotals();
            validateForm();
        };

        const updateTotals = () => {
            let subtotal = 0;
            state.items.forEach((item, index) => {
                const lineTotal = item.quantity * item.price;
                document.querySelector(`tr[data-index="${index}"] .item-total`).textContent = formatCurrency(lineTotal);
                subtotal += lineTotal;
            });
            
            const taxes = subtotal * (state.company.taxRate / 100);
            const total = subtotal + taxes;

            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('taxes').textContent = formatCurrency(taxes);
            document.getElementById('total').textContent = formatCurrency(total);
        };
        
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', currencyDisplay: 'symbol' })
                .format(value)
                .replace('COP', state.company.currency)
                .trim();
        };

        const addNewItem = () => {
            state.items.push({ description: '', quantity: 1, price: 0 });
            render();
        };

        const validateForm = () => {
            dom.generateBtn.disabled = !state.client.name;
        };
        
        const generateInvoicePreview = () => {
            const { company, invoice, client, items } = state;
            let subtotal = 0;
            let itemsHtml = '';
            items.forEach(item => {
                const total = item.quantity * item.price;
                subtotal += total;
                itemsHtml += `
                    <tr>
                        <td>${item.description}</td>
                        <td class="text-end">${item.quantity}</td>
                        <td class="text-end">${formatCurrency(item.price)}</td>
                        <td class="text-end fw-bold">${formatCurrency(total)}</td>
                    </tr>
                `;
            });
            const taxes = subtotal * (company.taxRate / 100);
            const total = subtotal + taxes;
            
            const previewContent = `
                <div class="p-4">
                    <div class="row align-items-center mb-4">
                        <div class="col-6">${company.logo ? `<img src="${company.logo}" style="max-height:80px;">` : `<h3>${company.name}</h3>`}</div>
                        <div class="col-6 text-end"><h2>FACTURA</h2><p><strong>Nº:</strong> ${invoice.number}</p></div>
                    </div>
                    <div class="row border-top pt-3 mb-4">
                        <div class="col-6">
                            <p class="text-muted mb-1">De:</p>
                            <strong>${company.name}</strong><br>
                            <small>${company.address.replace(/\n/g, '<br>')}</small>
                        </div>
                        <div class="col-6">
                            <p class="text-muted mb-1">Para:</p>
                            <strong>${client.name}</strong><br>
                            <small>${client.details.replace(/\n/g, '<br>')}</small>
                        </div>
                    </div>
                     <div class="row mb-4">
                        <div class="col-6"><p><strong>Fecha de Emisión:</strong> ${new Date(invoice.date + 'T00:00:00').toLocaleDateString('es-CO')}</p></div>
                        <div class="col-6"><p><strong>Fecha de Vencimiento:</strong> ${new Date(invoice.dueDate + 'T00:00:00').toLocaleDateString('es-CO')}</p></div>
                    </div>
                    <table class="table">
                        <thead class="table-light"><tr><th>Descripción</th><th class="text-end">Cant.</th><th class="text-end">Vlr. Unitario</th><th class="text-end">Total</th></tr></thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    <div class="row justify-content-end">
                        <div class="col-5">
                            <table class="table table-sm">
                                <tbody>
                                    <tr><td>Subtotal:</td><td class="text-end">${formatCurrency(subtotal)}</td></tr>
                                    <tr><td>Impuestos (${company.taxRate}%):</td><td class="text-end">${formatCurrency(taxes)}</td></tr>
                                    <tr><td class="fw-bold h5">TOTAL:</td><td class="text-end fw-bold h5">${formatCurrency(total)}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ${invoice.notes ? `<div class="mt-4"><p class="text-muted small"><strong>Notas:</strong><br>${invoice.notes}</p></div>` : ''}
                </div>
            `;
            document.getElementById('invoice-preview-content').innerHTML = previewContent;
            dom.invoicePreviewModal.show();
        };

        // --- Event Listeners ---
        dom.form.addEventListener('input', (e) => {
            const target = e.target;
            const itemRow = target.closest('tr');
            if (itemRow) {
                const index = itemRow.dataset.index;
                const field = target.dataset.field;
                state.items[index][field] = target.type === 'number' ? parseFloat(target.value) : target.value;
            } else {
                const [level, key] = target.id.split('-');
                if (state[level] && typeof state[level][key] !== 'undefined') {
                    state[level][key] = target.value;
                }
            }
            saveState();
            render();
        });

        dom.itemsContainer.addEventListener('click', e => {
            if (e.target.closest('.remove-item-btn')) {
                const index = e.target.closest('tr').dataset.index;
                state.items.splice(index, 1);
                if (state.items.length === 0) addNewItem(); // Ensure at least one row
                saveState();
                render();
            }
        });

        dom.addItemBtn.addEventListener('click', addNewItem);
        dom.generateBtn.addEventListener('click', generateInvoicePreview);
        dom.logoUploadContainer.addEventListener('click', () => dom.logoInput.click());
        dom.logoInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.company.logo = e.target.result;
                    saveState();
                    render();
                };
                reader.readAsDataURL(file);
            }
        });

        dom.saveSettingsBtn.addEventListener('click', () => {
            state.company.name = document.getElementById('company-name').value;
            state.company.address = document.getElementById('company-address').value;
            state.company.taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;
            state.company.currency = document.getElementById('currency-symbol').value;
            saveState();
            render();
        });

        dom.newInvoiceBtn.addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres empezar una nueva factura? Los datos del cliente y los items se borrarán.')) {
                // Increment invoice number
                const parts = state.invoice.number.split('-');
                const num = parseInt(parts[1] || 0) + 1;
                state.invoice.number = `${parts[0]}-${String(num).padStart(3, '0')}`;
                
                // Clear client and items
                state.client = { name: '', details: '' };
                state.items = [];
                state.invoice.date = new Date().toISOString().slice(0, 10);
                state.invoice.dueDate = '';
                state.invoice.notes = '';

                saveState();
                loadState(); // Reload to get a fresh start
                render();
            }
        });

        // Initial Load
        loadState();
        render();
    });
    </script>
</body>
</html>```