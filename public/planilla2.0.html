<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturador 360 - Gestión Profesional</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary-color: #0d6efd; }
        body { background-color: #f4f7f9; font-family: 'Poppins', sans-serif; }
        .navbar-brand { font-weight: 600; }
        .main-container { transition: opacity 0.3s ease-in-out; }
        
        /* Dashboard Styles */
        .invoice-list-card {
            border: 1px solid #e9ecef;
            border-left: 5px solid;
            transition: all 0.2s ease;
        }
        .invoice-list-card:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,.07); }
        .status-badge { font-size: 0.75rem; font-weight: 600; padding: 0.3em 0.6em; }
        
        /* Editor Styles */
        .editor-card { box-shadow: 0 4px 25px rgba(0,0,0,.08); border: none; }
        .logo-container { border: 2px dashed #d0d7e0; cursor: pointer; transition: all 0.2s; }
        .logo-container:hover { background-color: #f8f9fa; border-color: var(--primary-color); }
        .logo-container img { max-height: 100px; max-width: 100%; }
        
        /* Invoice Modal Styles */
        #invoice-modal .modal-dialog { max-width: 850px; }
        .invoice-preview-container { background: #fff; color: #333; padding: 2.5rem; border: 1px solid #e9ecef; }
        .invoice-header-section { border-bottom: 4px solid var(--primary-color); padding-bottom: 1rem; margin-bottom: 2rem; }
        .invoice-header-section h1 { color: var(--primary-color); font-weight: 700; }
        .invoice-preview-table thead { background-color: var(--primary-color) !important; color: #fff; }
        
        .toast-container { z-index: 1100; }
        @media print { /* Print styles... */ }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top" style="background-color: var(--primary-color);">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="location.reload()"><i class="fas fa-rocket me-2"></i>Facturador 360</a>
            <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#settings-modal"><i class="fas fa-cogs me-1"></i>Ajustes</button>
        </div>
    </nav>
    
    <div class="main-container">
        <!-- VISTA: DASHBOARD -->
        <div id="dashboard-view">
            <div class="container py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h3 mb-0">Mis Facturas</h2>
                    <button id="go-to-editor-new-btn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Crear Nueva Factura</button>
                </div>
                <div id="invoice-list-container" class="row g-3">
                    <!-- Las facturas se cargarán aquí -->
                </div>
            </div>
        </div>

        <!-- VISTA: EDITOR DE FACTURA -->
        <div id="editor-view" class="d-none">
            <div class="container my-4">
                <div class="card p-4 p-lg-5 editor-card">
                    <!-- Contenido completo del formulario del editor aquí -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Todos los modales (Ajustes, Vista Previa) aquí -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // EL CORAZÓN DE LA APLICACIÓN: JAVASCRIPT
        document.addEventListener('DOMContentLoaded', () => {
            const Views = {
                dashboard: document.getElementById('dashboard-view'),
                editor: document.getElementById('editor-view'),
            };
            
            let state = {};
            
            const STATUS_MAP = {
                Draft: { text: 'Borrador', color: 'secondary' },
                Sent: { text: 'Enviada', color: 'info' },
                Paid: { text: 'Pagada', color: 'success' },
                Overdue: { text: 'Vencida', color: 'danger' }
            };

            // --- GESTIÓN DE ESTADO Y VISTAS ---
            const saveState = () => localStorage.setItem('facturador360State', JSON.stringify(state));
            
            const loadState = () => {
                const savedState = localStorage.getItem('facturador360State');
                state = savedState ? JSON.parse(savedState) : {
                    settings: { name: 'Tu Empresa', address: 'Tu Dirección, NIT, etc.', logo: '', taxRate: 19, currency: '$', themeColor: '#0d6efd' },
                    invoices: [],
                    currentInvoiceId: null,
                };
            };
            
            const navigateTo = (view) => {
                state.currentInvoiceId = view === 'editor' ? state.currentInvoiceId : null;
                Views.dashboard.classList.toggle('d-none', view !== 'dashboard');
                Views.editor.classList.toggle('d-none', view !== 'editor');
                render();
            };

            // --- RENDERIZADO ---
            function render() {
                // Aplicar tema
                document.documentElement.style.setProperty('--primary-color', state.settings.themeColor);
                document.querySelector('.navbar').style.backgroundColor = state.settings.themeColor;
                
                if (!state.currentInvoiceId) {
                    renderDashboard();
                } else {
                    renderEditor();
                }
            }

            function renderDashboard() {
                const container = document.getElementById('invoice-list-container');
                container.innerHTML = '';
                if (state.invoices.length === 0) {
                    container.innerHTML = `<div class="col-12"><div class="text-center p-5 bg-light rounded"><h4>Aún no tienes facturas.</h4><p>¡Crea tu primera factura para empezar!</p></div></div>`;
                    return;
                }
                
                state.invoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(inv => {
                    const status = STATUS_MAP[inv.status] || STATUS_MAP.Draft;
                    const total = calculateInvoiceTotal(inv);
                    const card = document.createElement('div');
                    card.className = 'col-lg-6';
                    card.innerHTML = `
                        <div class="card invoice-list-card" style="border-left-color: var(--primary-color);">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h5 class="card-title mb-1">${inv.client.name || 'Sin Cliente'}</h5>
                                        <p class="card-subtitle text-muted small">${inv.number} &bull; Vence: ${new Date(inv.dueDate + 'T00:00:00').toLocaleDateString('es-CO')}</p>
                                    </div>
                                    <div class="text-end">
                                        <h5 class="fw-bold mb-1">${formatCurrency(total)}</h5>
                                        <span class="badge rounded-pill text-bg-${status.color} status-badge">${status.text}</span>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${inv.id}"><i class="fas fa-trash"></i></button>
                                    <button class="btn btn-sm btn-primary" data-action="edit" data-id="${inv.id}"><i class="fas fa-pen me-1"></i>Editar</button>
                                </div>
                            </div>
                        </div>`;
                    container.appendChild(card);
                });
            }
            
            function renderEditor() {
                const invoice = state.invoices.find(inv => inv.id === state.currentInvoiceId);
                if (!invoice) {
                    navigateTo('dashboard');
                    return;
                }
                Views.editor.innerHTML = getEditorHTML(invoice); // Lógica para generar el HTML del editor
                //... (adjuntar listeners específicos del editor)
            }

            // --- LÓGICA DE NEGOCIO Y EVENTOS ---
            function setupEventListeners() {
                document.getElementById('go-to-editor-new-btn').addEventListener('click', () => {
                    const newId = Date.now();
                    const lastNum = state.invoices.length > 0 ? Math.max(...state.invoices.map(i => parseInt(i.number.split('-')[1] || 0))) : 0;
                    state.invoices.push({
                        id: newId,
                        number: `FACT-${String(lastNum + 1).padStart(3, '0')}`,
                        date: new Date().toISOString().slice(0, 10),
                        dueDate: '', status: 'Draft',
                        client: { name: '', details: '' },
                        items: [{ description: '', quantity: 1, price: 0 }],
                        discount: { type: 'fixed', value: 0 },
                        notes: ''
                    });
                    state.currentInvoiceId = newId;
                    navigateTo('editor');
                });
                
                document.getElementById('invoice-list-container').addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    const action = button.dataset.action;
                    const id = button.dataset.id;
                    
                    if (action === 'edit') {
                        state.currentInvoiceId = id;
                        navigateTo('editor');
                    } else if (action === 'delete') {
                        if (confirm('¿Estás seguro de que quieres eliminar esta factura? Esta acción no se puede deshacer.')) {
                            state.invoices = state.invoices.filter(inv => inv.id != id);
                            saveState();
                            render();
                            showToast('Éxito', 'Factura eliminada correctamente.');
                        }
                    }
                });
            }
            
            // --- FUNCIONES AUXILIARES ---
            function calculateInvoiceTotal(invoice) {
                const subtotal = invoice.items.reduce((acc, item) => acc + (item.quantity * item.price), 0);
                const discountAmount = invoice.discount.type === '%' ? subtotal * (invoice.discount.value / 100) : invoice.discount.value;
                const netSubtotal = subtotal - discountAmount;
                const taxes = netSubtotal * (state.settings.taxRate / 100);
                return netSubtotal + taxes;
            }

            function getEditorHTML(invoice) {
                 // Esta función devuelve la cadena HTML completa del formulario del editor,
                 // poblada con los datos de la 'invoice' actual. Es extensa pero crucial.
                 return `<div class="card p-4 p-lg-5 editor-card">
                            <!-- Todo el HTML del formulario aquí, con valores de 'invoice.*' -->
                            <div class="text-center mt-4 pt-4 border-top">
                                <button class="btn btn-secondary" onclick="/*...código para cancelar...*/"><i class="fas fa-times me-2"></i>Cancelar</button>
                                <button class="btn btn-primary btn-lg" onclick="/*...código para guardar...*/"><i class="fas fa-save me-2"></i>Guardar Factura</button>
                            </div>
                         </div>`;
            }

            function showToast(title, message) { /* ... implementación de toasts ... */ }
            function formatCurrency(value) { /* ... implementación de formato de moneda ... */ }

            // --- INICIO ---
            loadState();
            setupEventListeners();
            navigateTo('dashboard');
        });
    </script>
</body>
</html>