<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Planilla General - DIBA FBC</title>
  <meta name="author" content="REINALDO DE JESUS PEREZ NAVAS" />
  <meta name="keywords" content="DIBA FBC, Deportivo Internacional De Barranquilla Atlántico, Fútbol, Barranquilla, Atlántico, Colombia" />
  <meta name="description" content="Planilla interactiva para el control de jugadores del club DIBA FBC. Conoce la historia y los momentos más destacados." />
  <meta name="robots" content="index, follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Theming -->
  <meta name="theme-color" content="#002a40" />
  <meta name="apple-mobile-web-app-status-bar-style" content="#002a40" />
  <meta name="msapplication-navbutton-color" content="#002a40" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />

  <!-- Favicons -->
  <link rel="icon" href="images/ESCUDO.ico" sizes="32x32">
  <link rel="icon" href="https://i.postimg.cc/x8W7vwJJ/ESCUDO.png" type="image/png">

  <!-- Bootstrap 5.3.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <!-- Animate.css (Opcional, si se usa) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- JS Libraries for PDF Generation -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Estilos Personalizados -->
  <style>
    :root {
      --primary-color: #002a40;
      --secondary-color: #0077b6;
      --accent-color: #e9d8a6;
      --bs-body-bg: #f8f9fa;
    }
    body {
      background-color: var(--bs-body-bg);
      padding-bottom: 5rem;
    }
    .navbar {
      background-color: var(--primary-color) !important;
    }
    .table-responsive {
      max-height: 65vh;
      overflow-y: auto;
    }
    .table th {
      background-color: var(--primary-color);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .action-btn {
      opacity: 0.5;
      transition: opacity 0.2s ease-in-out;
    }
    tr:hover .action-btn {
      opacity: 1;
    }
    #generatePDF:disabled {
      cursor: not-allowed;
    }
    .toast-container {
      z-index: 1100;
    }
  </style>
</head>

<body>
  <!-- Contenedor para Notificaciones -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i class="fas fa-check-circle text-success me-2"></i>
        <strong class="me-auto">Notificación</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

   <!-- Contenedor para el Navbar (se carga desde layout/navbar.html) -->
  <div id="navbar-container"></div>

  <main class="container mt-4">
    <!-- Encabezado de la página -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h1 class="mb-0 h2">Planilla General</h1>
      <div class="d-flex gap-3 align-items-center mt-2 mt-md-0">
        <div>
          <label for="planillaCategory" class="form-label mb-0 fw-bold small">Categoría:</label>
          <input type="text" class="form-control" id="planillaCategory" placeholder="Ej: 2010-2011" style="width: auto;">
        </div>
        <div>
          <label for="planillaDate" class="form-label mb-0 fw-bold small">Fecha:</label>
          <input type="date" class="form-control" id="planillaDate" style="width: auto;">
        </div>
      </div>
    </div>

    <!-- Controles Principales -->
    <div class="card shadow-sm mb-4">
      <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-3">
        <!-- Sección para añadir jugador -->
        <form id="addPlayerForm" class="d-flex gap-2">
          <input type="text" id="newPlayerName" class="form-control" placeholder="Nombre del nuevo jugador" required>
          <button type="submit" class="btn btn-success" aria-label="Añadir Jugador">
            <i class="fas fa-plus"></i> Añadir
          </button>
        </form>
        <!-- Botones de acción -->
        <div class="d-flex gap-2">
          <button id="generatePDF" class="btn btn-primary">
            <span id="pdf-icon"><i class="fas fa-file-pdf"></i></span>
            <span id="pdf-text"> Descargar PDF</span>
          </button>
          <button id="clearData" class="btn btn-danger" data-bs-toggle="tooltip" title="Borra pagos, asistencia y observaciones. No borra la lista de jugadores.">
            <i class="fas fa-eraser"></i> Limpiar Planilla
          </button>
        </div>
      </div>
    </div>

    <!-- Tabla Interactiva -->
    <div class="table-responsive shadow-sm">
      <table class="table table-striped table-hover table-bordered" id="planillaTable">
        <thead class="table-dark">
          <tr>
            <th style="width: 5%;">#</th>
            <th>Nombre</th>
            <th style="width: 15%;">Pago</th>
            <th style="width: 15%;">Asistencia</th>
            <th style="width: 25%;">Observaciones</th>
            <th style="width: 5%;" class="text-center">Acción</th>
          </tr>
        </thead>
        <tbody id="planillaBody">
          <!-- Las filas se generan con JavaScript -->
        </tbody>
      </table>
    </div>
  </main>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- ELEMENTOS DEL DOM ---
      const tableBody = document.getElementById('planillaBody');
      const addPlayerForm = document.getElementById('addPlayerForm');
      const newPlayerNameInput = document.getElementById('newPlayerName');
      const generatePdfBtn = document.getElementById('generatePDF');
      const clearDataBtn = document.getElementById('clearData');
      const dateInput = document.getElementById('planillaDate');
      const categoryInput = document.getElementById('planillaCategory');
      const toastElement = document.getElementById('appToast');
      const bsToast = new bootstrap.Toast(toastElement);

      // Inicializar tooltips de Bootstrap
      new bootstrap.Tooltip(clearDataBtn);

      // --- ESTADO DE LA APLICACIÓN (LA ÚNICA FUENTE DE VERDAD) ---
      let appState = {
        players: [],
        data: {}, // { 'player_id': { pago: '', asistencia: '', observacion: '' } }
        category: ''
      };

      // --- FUNCIONES DE MANEJO DE DATOS ---
      const showToast = (message, isError = false) => {
        toastElement.querySelector('.toast-body').textContent = message;
        const icon = toastElement.querySelector('.toast-header i');
        icon.className = isError ? 'fas fa-exclamation-circle text-danger me-2' : 'fas fa-check-circle text-success me-2';
        bsToast.show();
      };

      const saveState = () => {
        appState.category = categoryInput.value;
        localStorage.setItem('dibaFbcAppState', JSON.stringify(appState));
      };

      const loadState = () => {
        const savedState = localStorage.getItem('dibaFbcAppState');
        if (savedState) {
          appState = JSON.parse(savedState);
        }
        categoryInput.value = appState.category || '';
        if (!dateInput.value) {
            dateInput.valueAsDate = new Date();
        }
      };

      // --- RENDERIZADO DE LA TABLA HTML ---
      const renderTable = () => {
        tableBody.innerHTML = '';
        if (appState.players.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted p-4">No hay jugadores en la lista. ¡Añade uno para empezar!</td></tr>`;
          return;
        }

        appState.players.forEach((player, index) => {
          const playerData = appState.data[player.id] || { pago: '', asistencia: 'P', observacion: '' };
          const row = document.createElement('tr');
          row.dataset.playerId = player.id;

          row.innerHTML = `
            <td><b>${index + 1}</b></td>
            <td class="fw-medium">${player.name}</td>
            <td><input type="text" class="form-control form-control-sm data-input" data-field="pago" placeholder="$0" value="${playerData.pago}"></td>
            <td>
              <select class="form-select form-select-sm data-input" data-field="asistencia">
                <option value="P" ${playerData.asistencia === 'P' ? 'selected' : ''}>Presente</option>
                <option value="A" ${playerData.asistencia === 'A' ? 'selected' : ''}>Ausente</option>
                <option value="E" ${playerData.asistencia === 'E' ? 'selected' : ''}>Excusa</option>
              </select>
            </td>
            <td><input type="text" class="form-control form-control-sm data-input" data-field="observacion" placeholder="Sin novedad" value="${playerData.observacion}"></td>
            <td class="text-center">
              <button class="btn btn-sm btn-link text-danger p-0 action-btn btn-delete" aria-label="Eliminar a ${player.name}">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      };

      // --- MANEJADORES DE EVENTOS ---
      addPlayerForm.addEventListener('submit', e => {
        e.preventDefault();
        const newName = newPlayerNameInput.value.trim();
        if (newName) {
          appState.players.push({ id: Date.now(), name: newName });
          newPlayerNameInput.value = '';
          saveState();
          renderTable();
          showToast(`Jugador "${newName}" añadido.`);
        }
      });

      tableBody.addEventListener('click', e => {
        if (e.target.closest('.btn-delete')) {
          const row = e.target.closest('tr');
          const playerId = Number(row.dataset.playerId);
          const player = appState.players.find(p => p.id === playerId);

          if (confirm(`¿Eliminar a ${player.name} de la lista?`)) {
            appState.players = appState.players.filter(p => p.id !== playerId);
            delete appState.data[playerId];
            saveState();
            renderTable();
            showToast(`Jugador "${player.name}" eliminado.`, true);
          }
        }
      });

      tableBody.addEventListener('input', e => {
        if (e.target.classList.contains('data-input')) {
          const row = e.target.closest('tr');
          const playerId = Number(row.dataset.playerId);
          const field = e.target.dataset.field;

          if (!appState.data[playerId]) {
            appState.data[playerId] = { pago: '', asistencia: 'P', observacion: '' };
          }
          appState.data[playerId][field] = e.target.value;
          saveState();
        }
      });

      clearDataBtn.addEventListener('click', () => {
        if (confirm('¿Limpiar todos los datos de pago, asistencia y observaciones? La lista de jugadores no se borrará.')) {
          appState.data = {};
          saveState();
          renderTable();
          showToast('Datos de la planilla limpiados.');
        }
      });

      categoryInput.addEventListener('input', saveState);

      // --- GENERACIÓN DE PDF ---
      generatePdfBtn.addEventListener('click', async () => {
        const btn = generatePdfBtn;
        const pdfIcon = document.getElementById('pdf-icon');
        const pdfText = document.getElementById('pdf-text');
        const originalIconHTML = pdfIcon.innerHTML;
        const originalTextContent = pdfText.textContent;

        // Feedback visual de carga
        btn.disabled = true;
        pdfIcon.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
        pdfText.textContent = ' Generando...';

        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

          // Cargar logo
          try {
            const logoUrl = "https://diba-fbc.vercel.app/index.html";
            const response = await fetch(logoUrl);
            const blob = await response.blob();
            const imgData = await new Promise(resolve => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.readAsDataURL(blob);
            });
            doc.addImage(imgData, 'PNG', 40, 30, 60, 60);
          } catch (err) {
            console.error("Error cargando logo para PDF:", err);
            showToast("No se pudo cargar el logo para el PDF.", true);
          }

          // Encabezados y títulos del PDF
          doc.setFontSize(16).setFont('helvetica', 'bold').text("DIBA FBC", 115, 50);
          doc.setFontSize(10).setFont('helvetica', 'normal');
          doc.text("DEPORTIVO INTERNACIONAL DE BARRANQUILLA ATLANTICO", 115, 65);
          doc.text("RESOLUCIÓN 0122 / 10-SEPT-2018", 115, 80);
          doc.setFontSize(12).setFont('helvetica', 'bold').text("PLANILLA GENERAL DE CONTROL", doc.internal.pageSize.getWidth() / 2, 120, { align: 'center' });

          // Fecha y Categoría
          const planillaDate = dateInput.value ? new Date(dateInput.value + 'T00:00:00').toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' }) : "No especificada";
          const planillaCategory = categoryInput.value.trim() || "No especificada";
          doc.setFontSize(10).setFont('helvetica', 'normal');
          doc.text(`Fecha: ${planillaDate}`, 40, 140);
          doc.text(`Categoría: ${planillaCategory}`, doc.internal.pageSize.getWidth() - 40, 140, { align: 'right' });

          // Preparar datos para la tabla del PDF
          const head = [["#", "Nombre", "Pago", "Asistencia", "Observaciones"]];
          let body;

          if (appState.players.length === 0) {
            body = []; // Crear tabla vacía si no hay jugadores
            for (let i = 1; i <= 40; i++) { body.push([i, '', '', '', '']); }
          } else {
            body = appState.players.map((player, index) => {
              const playerData = appState.data[player.id] || {};
              const asistenciaText = { P: 'Presente', A: 'Ausente', E: 'Excusa' }[playerData.asistencia] || '';
              return [index + 1, player.name, playerData.pago || '', asistenciaText, playerData.observacion || ''];
            });
          }

          // Generar tabla en PDF
          doc.autoTable({
            head: head,
            body: body,
            startY: 160,
            theme: 'grid',
            headStyles: { fillColor: [0, 42, 64], textColor: 255, fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [240, 248, 255] },
            columnStyles: {
              0: { halign: 'center', cellWidth: 30 }, // #
              1: { cellWidth: 'auto' }, // Nombre
              2: { halign: 'center', cellWidth: 70 }, // Pago
              3: { halign: 'center', cellWidth: 70 }, // Asistencia
            }
          });

          // Pie de página en el PDF
          const pageCount = doc.internal.getNumberOfPages();
          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8).setTextColor(150);
            doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 20, { align: 'center' });
            doc.text(`Generado el ${new Date().toLocaleDateString('es-CO')} a las ${new Date().toLocaleTimeString('es-CO')}`, doc.internal.pageSize.getWidth() - 40, doc.internal.pageSize.getHeight() - 20, { align: 'right' });
          }

          // Descargar el PDF
          const safeCategory = planillaCategory.replace(/[^a-z0-9]/gi, '_');
          const safeDate = dateInput.value || new Date().toISOString().slice(0, 10);
          doc.save(`Planilla_DIBA_FBC_${safeCategory}_${safeDate}.pdf`);
          showToast('PDF generado con éxito.');

        } catch (error) {
          console.error('Error al generar el PDF:', error);
          showToast('Ocurrió un error al generar el PDF.', true);
        } finally {
          // Restaurar estado del botón
          btn.disabled = false;
          pdfIcon.innerHTML = originalIconHTML;
          pdfText.textContent = originalTextContent;
        }
      });

      // --- INICIALIZACIÓN ---
      loadState();
      renderTable();
    });
  </script>
  <!-- Contenedor para el Footer (se carga desde layout/footer.html) -->
  <div id="footer-container"></div>

  <!-- Script para cargar componentes externos (Navbar y Footer) -->
  <script src="scripts/loadComponents.js"></script>

  <!-- Script principal (funciones y animaciones) -->
  <script src="scripts/main.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="api/supabases.js"></script> 

</body>
</html>